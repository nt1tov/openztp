# OpenZTP
OpenZTP server to automatic provision OpenWRT devices

*****RU****
Openwrt устройство получает от dhcp сервера адрес ztp сервера в опции next-server, а также bootfile, который используется как некий идентификатор ztp сервера, чтобы отсеять другие возможные dhcp сервера. Далее устройство регистрируется по протоколу http на ztp сервере, при этом посылает некоторые свои параметры (mac, hostname, release). Настройки полученные по dhcp, сохраняются в файле /etc/register.conf.
Ztp сервер осуществляет раздачу файлов по http протоколу, например прошивку.
Ztp сервер, при поступлении запроса на регистрацию устройства, проверяет, нет ли уже такого зарегистрированного устройства. Идентификатором устройства служит его mac адрес (потом переделаю на id). Если устройство уже зарегистрировано, сервер обновляет параметры устройства в БД, если нет, то регистрирует и выполняет инициализацию устройства путем выполнения скрипта init.sh на нем. В текущей реализации, init.sh скрипт устанавливает hostname и обновляет прошивку, если она отличается от текущей.

Основной исполняемый файл wrt. Реализует иннтерфейс командной строки, а также интерфейс собственной командной строки в режиме сервера. Для обоих режимов используется один и тот же парсер на основе стандартной python библиотеки argparse. Подкоманды парсера разбиты по модулям в каталоге commands.

Модули:
device: реализует работу с SQL БД. Работа с БД абстрагирована от конкретной реализации с помощью ORM, для этого используется веб фреймворк django. Настройки базы данных находятся в конфигурационном файле django openwrt/settings.py. Создание схемы БД "python manage.py migrate".

script: реализует выполнение скриптов на устройствах. Скрипты выполняются по ssh. При этом, файл скрипта заливается на устройство в каталог /tmp, далее запукается с нужными параметрами. Взаимодействие по ssh реализовано с помощью библиотеки pexpect.

log: Настраивает общее логирование и реализует работу с логом. Логирование на базе стандартной библиотеки logger.

Доролнительный модуль http_server.py реализует http сервер, для раздачи файлов и обработки запросов на регистрацию устройств. С помощью микро веб фреймворка flask. Http сервер выполняется в отдельном фоновом потоке, используется стандартная библиотека threading.


***********
